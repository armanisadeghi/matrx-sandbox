# docker-compose.yml — Local development environment
#
# Profiles:
#   default (no profile)  → orchestrator + LocalStack (fully local, no AWS needed)
#   --profile production  → orchestrator with real Postgres + S3 (uses .env file)
#
# Usage (local with LocalStack):
#   docker compose up
#
# Usage (local with real backends):
#   docker compose --profile production up orchestrator-prod
#
# Quick test:
#   curl -X POST http://localhost:8000/sandboxes \
#     -H "Content-Type: application/json" \
#     -d '{"user_id": "00000000-0000-0000-0000-000000000001"}'

services:
  orchestrator:
    build:
      context: ./orchestrator
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - MATRX_S3_BUCKET=${MATRX_S3_BUCKET:-matrx-sandbox-dev}
      - MATRX_S3_REGION=${MATRX_S3_REGION:-us-east-1}
      - MATRX_DEBUG=true
      - MATRX_SANDBOX_IMAGE=matrx-sandbox:latest
      # Route S3 requests to LocalStack instead of real AWS
      - AWS_ENDPOINT_URL_S3=http://localstack:4566
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./orchestrator:/app
    depends_on:
      - localstack
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped

  # Production-like local run: real Postgres + real S3, no LocalStack
  orchestrator-prod:
    build:
      context: ./orchestrator
      dockerfile: Dockerfile
    profiles:
      - production
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      - MATRX_DEBUG=true
      - MATRX_SANDBOX_IMAGE=matrx-sandbox:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./orchestrator:/app
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped

  # LocalStack for local S3 development (no AWS account needed)
  localstack:
    image: localstack/localstack:latest
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3
      - DEFAULT_REGION=us-east-1
    volumes:
      - localstack-data:/var/lib/localstack

volumes:
  localstack-data:
